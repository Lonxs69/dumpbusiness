name: Deploy Database Dump to Production

on:
  push:
    branches: [ main, master ]
    paths: 
      - "*.dump"
  workflow_dispatch:
    inputs:
      dump_file:
        description: 'Nombre del archivo dump a desplegar'
        required: true
        type: string

jobs:
  deploy-dump:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup PostgreSQL Client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client-15
    
    - name: Find dump file
      id: find_dump
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          DUMP_FILE="${{ github.event.inputs.dump_file }}"
        else
          DUMP_FILE=$(ls *.dump | head -1)
        fi
        echo "dump_file=$DUMP_FILE" >> $GITHUB_OUTPUT
        echo "Found dump file: $DUMP_FILE"
    
    - name: Backup current database (optional)
      run: |
        echo "Creating backup before restore..."
        pg_dump -h ${{ secrets.RDS_HOST }} -p 5432 -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }} > backup_$(date +%Y%m%d_%H%M%S).sql
      env:
        PGPASSWORD: ${{ secrets.DB_PASSWORD }}
    
    - name: Clear database
      run: |
        psql -h ${{ secrets.RDS_HOST }} -p 5432 -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }} -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
      env:
        PGPASSWORD: ${{ secrets.DB_PASSWORD }}
    
    - name: Restore new dump
      run: |
        pg_restore -h ${{ secrets.RDS_HOST }} -p 5432 -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }} -v ${{ steps.find_dump.outputs.dump_file }}
      env:
        PGPASSWORD: ${{ secrets.DB_PASSWORD }}
    
    - name: Verify restoration
      run: |
        psql -h ${{ secrets.RDS_HOST }} -p 5432 -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }} -c "SELECT COUNT(*) as total_users FROM users;"
      env:
        PGPASSWORD: ${{ secrets.DB_PASSWORD }}

    - name: Notify success
      run: |
        echo "âœ… Database dump ${{ steps.find_dump.outputs.dump_file }} deployed successfully to production!"
